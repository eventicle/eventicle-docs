<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Eventicle JS</title>
    <link rel="canonical" href="https://book.eventicle.com/eventiclejs/book/query.html">
    <meta name="generator" content="Antora 3.1.2">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize("{ startOnLoad: true }");</script><header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://book.eventicle.com">Eventicle JS</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Components</a>
          <div class="navbar-dropdown">
              <a class="navbar-item" href="../index.html">EventicleJS</a>
              <a class="navbar-item" href="../../eventicle-utilities/main/index.html">EventicleJS Utilities</a>
              <a class="navbar-item" href="../../datastore-postgres/main/index.html">Postgres Datastore</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="https://github.com/eventicle/eventiclejs">EventicleJS Repository</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="eventiclejs" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">EventicleJS</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../index.html">The Book of Eventicle</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Core Concepts</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="aggregate-roots.html">Aggregate Roots</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="aggregate-root-xstate.html">XState Aggregate Root -  Formal State Machines</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="commands.html">Commands</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="sagas.html">Event Sagas</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="query.html">Event Views</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="datastore.html">The Datastore</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">How To</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="observability.html">Observability</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="testing.html">Testing</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">API documentation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../api/eventicle_eventiclejs.html">@eventicle/eventiclejs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_AggregateRoot_class.html">AggregateRoot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_Command_interface.html">Command</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_CommandIntent_interface.html">CommandIntent</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_CommandReturn_interface.html">CommandReturn</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EncodedEvent_interface.html">EncodedEvent</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventAdapter_interface.html">EventAdapter</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventClient_interface.html">EventClient</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventClientCodec_interface.html">EventClientCodec</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventicleEvent_interface.html">EventicleEvent</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventView_interface.html">EventView</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_InMemoryDatastore_class.html">InMemoryDatastore</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_LocalScheduleJobRunner_class.html">LocalScheduleJobRunner</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_RawEventView_interface.html">RawEventView</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_Saga_class.html">Saga</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_SagaInstance_class.html">SagaInstance</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_XStateAggregate_class.html">XStateAggregate</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">EventicleJS</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">EventicleJS</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../eventicle-utilities/main/index.html">EventicleJS Utilities</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../eventicle-utilities/main/index.html">main</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../datastore-postgres/main/index.html">Postgres Datastore</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../datastore-postgres/main/index.html">main</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">EventicleJS</a></li>
    <li><a href="../index.html">The Book of Eventicle</a></li>
    <li>Core Concepts</li>
    <li><a href="query.html">Event Views</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/eventicle/eventiclejs/edit/master/docs/modules/book/pages/query.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div class="sect1">
<h2 id="_querying_data_views"><a class="anchor" href="#_querying_data_views"></a>Querying Data: Views</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An event View is a component that observes event streams and applies a <em>Reducer</em> function to them to generate a data structure
that is suitable for querying.</p>
</div>
<div class="paragraph">
<div class="title">An example View: Users</div>
<p>Create a list of users from <code>user.created</code> events and provider operations for users.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">import {
  setEventSourceName,
  eventClientOnDatastore,
  InMemoryDatastore,
  setDataStore,
  setEventClient, eventClient, EventicleEvent, EventView, dataStore, registerView
} from '@eventicle/eventiclejs';

class UserLoginView implements EventView {

  consumerGroup: string = "user_login_view"  <i class="conum" data-value="1"></i><b>(1)</b>
  streamsToSubscribe: string[] = ["app.users"]    <i class="conum" data-value="2"></i><b>(2)</b>

  /**
   * View reducer function.
   */
  async handleEvent(event: EventicleEvent): Promise&lt;void&gt; {

    switch(event.type) {  <i class="conum" data-value="3"></i><b>(3)</b>
      case "user.register":
        // Insert into some data store.  Here using the built in datastore abstraction so we can do InMem during testing
        await dataStore().createEntity("example", "user-view-record", {
          username: event.data.username,
          password: event.data.password
        })

        break;

      default:
        console.log("UserLoginView ignoring event type " + event.type)
    }
  }

  /*
   * An operation on the view. These will most commonly be API driven, and can any for of query.
   * They should only read the data, not attempt to mutate it
   */
  async checkPassword(username: string, password: string) {  <i class="conum" data-value="4"></i><b>(4)</b>
    // do a hash/ password comparison
  }

  async allUsers() {  <i class="conum" data-value="5"></i><b>(5)</b>
    (await dataStore().findEntity("example", "user-view-record", {})).map(value =&gt; {
      return value.content
    })
  }
}

async function execute() {
  setEventSourceName('my-cool-service');
  setDataStore(new InMemoryDatastore());
  setEventClient(eventClientOnDatastore());

  let view = new UserLoginView()
  await registerView(view) <i class="conum" data-value="6"></i><b>(6)</b>

  await eventClient().emit([
    {
      type: "user.created",
      data: {
        userName: "Personal Person"
      }
    }
  ], "app.users")

  console.log(await view.allUsers())   <i class="conum" data-value="7"></i><b>(7)</b>


}

execute()</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The consumer group is the same as for Redis Streams/ Kafka. Multiple view instances across processes will share processing.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>1..n streams to subscribe to.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>View must handle all the potential event types in the stream. Normally this is done by picking out the required types and ignoring any others.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>An operation on a view does not have to be a simple query, it can be more advanced, as with a login check. It does though, always have to be read only to preserve the 1 way data flow semantics of the system</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>A simple select all query on the view data structure.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Register the view with Eventicle for it to attach the streams to the view.  Maintain a reference to it for your use to query the view data.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>View will have the user record when this event has been async processed.</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_in_memory_views"><a class="anchor" href="#_in_memory_views"></a>In Memory Views</h3>
<div class="paragraph">
<p>The persisted nature of event streams means that you can use the event stream as the system persistence Then have your views
be purely in memory. This means that they will rebuild each time the application starts, but will require no external data storage.</p>
</div>
<div class="paragraph">
<div class="title">An example View: Count of Users</div>
<p>Count the user registrations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">import {
  setEventSourceName,
  eventClientOnDatastore,
  InMemoryDatastore,
  setDataStore,
  setEventClient, eventClient, EventicleEvent, EventView, dataStore, registerView
} from '@eventicle/eventiclejs';
import * as uuid from "uuid";
import {pause} from "@eventicle/eventiclejs/dist/util";

class UserLoginView implements EventView {

  consumerGroup: string = "user_count_view" + uuid.v4()  <i class="conum" data-value="1"></i><b>(1)</b>
  streamsToSubscribe: string[] = ["app.users"]

  userRegistrations:number = 0; <i class="conum" data-value="2"></i><b>(2)</b>

  async handleEvent(event: EventicleEvent): Promise&lt;void&gt; {
    switch(event.type) {
      case "user.register":
        this.userRegistrations++;  <i class="conum" data-value="3"></i><b>(3)</b>
        break;
    }
  }
}

async function execute() {
  setEventSourceName('my-cool-service');
  setDataStore(new InMemoryDatastore());
  setEventClient(eventClientOnDatastore());

  await eventClient().emit([
    {
      type: "user.created",
      data: {
        userName: "Personal Person"
      }
    }
  ], "app.users")

  let view = new UserLoginView()
  await registerView(view)  <i class="conum" data-value="5"></i><b>(5)</b>

  await pause(2000) // let the view come up to date

  console.log(await view.userRegistrations)   <i class="conum" data-value="4"></i><b>(4)</b>


}

execute()</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the consumer group to be random. This means this instance will fully replay every time it connects to the event stream, and will receive all events, not share with other instances.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The view state, in this case as simple integer count.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Implement eventual consistency of the user counter via the event stream reducer in this view.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Will output <code>1</code>, showing that the view observed the event that was emitted before it was connected, due to the full replay of the stream.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Eventicle will connect the view to the requested event streams.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
