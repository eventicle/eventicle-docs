<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Eventicle JS</title>
    <link rel="canonical" href="https://book.eventicle.com/eventiclejs/book/observability.html">
    <meta name="generator" content="Antora 3.1.7">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js'; mermaid.initialize("{ startOnLoad: true }");</script><header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://book.eventicle.com">Eventicle JS</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Components</a>
          <div class="navbar-dropdown">
              <a class="navbar-item" href="../index.html">EventicleJS</a>
              <a class="navbar-item" href="../../eventicle-utilities/main/index.html">EventicleJS Utilities</a>
              <a class="navbar-item" href="../../datastore-postgres/main/index.html">Postgres Datastore</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="https://github.com/eventicle/eventiclejs">EventicleJS Repository</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="eventiclejs" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">EventicleJS</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../index.html">The Book of Eventicle</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Core Concepts</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="aggregate-roots.html">Aggregate Roots</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="aggregate-root-xstate.html">XState Aggregate Root -  Formal State Machines</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="commands.html">Commands</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="sagas.html">Event Sagas</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="query.html">Event Views</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="datastore.html">The Datastore</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">How To</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="observability.html">Observability</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="testing.html">Testing</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">API documentation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../api/eventicle_eventiclejs.html">@eventicle/eventiclejs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_AggregateRoot_class.html">AggregateRoot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_Command_interface.html">Command</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_CommandIntent_interface.html">CommandIntent</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_CommandReturn_interface.html">CommandReturn</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EncodedEvent_interface.html">EncodedEvent</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventAdapter_interface.html">EventAdapter</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventClient_interface.html">EventClient</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventClientCodec_interface.html">EventClientCodec</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventicleEvent_interface.html">EventicleEvent</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventView_interface.html">EventView</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_InMemoryDatastore_class.html">InMemoryDatastore</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_LocalScheduleJobRunner_class.html">LocalScheduleJobRunner</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_RawEventView_interface.html">RawEventView</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_Saga_class.html">Saga</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_SagaInstance_class.html">SagaInstance</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">EventicleJS</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">EventicleJS</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../eventicle-utilities/main/index.html">EventicleJS Utilities</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../eventicle-utilities/main/index.html">main</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../datastore-postgres/main/index.html">Postgres Datastore</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../datastore-postgres/main/index.html">main</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">EventicleJS</a></li>
    <li><a href="../index.html">The Book of Eventicle</a></li>
    <li>How To</li>
    <li><a href="observability.html">Observability</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/eventicle/eventiclejs/edit/master/docs/modules/book/pages/observability.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div class="sect1">
<h2 id="_monitoring"><a class="anchor" href="#_monitoring"></a>Monitoring</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_apm"><a class="anchor" href="#_apm"></a>APM</h3>
<div class="paragraph">
<p><em>Support for distributed tracing is experimental, and the API is subject to change</em></p>
</div>
<div class="paragraph">
<p>Distributed Tracing is a very useful tool for monitoring system health and diagnosing issues in distributed systems.</p>
</div>
<div class="paragraph">
<p>Eventicle is event based, which poses some challenges to implementing distributed tracing, which normally assumes
that a transaction is RPC based and forms a tree structure in its interactions.</p>
</div>
<div class="paragraph">
<p>Event based systems do not generally form an interaction tree, instead they form a graph structure that when visualised will
give overlapping concepts of a "transaction".</p>
</div>
<div class="paragraph">
<p>Given that, distributed tracing is not universally useful in an Eventicle system in the way that it is in an HTTP/ RPC system.</p>
</div>
<div class="paragraph">
<p>It is most useful when you use it from the point of view of your API layer, and use it to trace interactions that relate to that API.</p>
</div>
<div class="paragraph">
<p>This is supported in Eventicle, via the <code>ApmApi</code> object.</p>
</div>
<div class="paragraph">
<p>Currently, only Elastic APM is supported, and can be enabled like so</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">// at the start of your index file, before any imports, to enable the agent to instrument correctly.
const apm = require('elastic-apm-node').start({
    serviceName: 'my-cool-service'
  });

import {apm as eventicleApm} from "@eventicle/eventiclejs";

eventicleApm.setEventicleApm(eventicleApm.elasticApmEventicle(apm))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will generate APM spans (and transactions) using the underlying API, and attach trace information to events. Transmitting
that information across transports is specific to the transport.  The codec will also need to ensure that it
collects that information and recreates it appropriately.</p>
</div>
<div class="paragraph">
<p>The default <code>EventClientJsonCodec</code> and both the <code>eventClientOnDatastore</code> and <code>eventClientOnKafka</code> support distributed trace headers.
<code>EventClientJsonCodec</code> currently sets trace headers compatible with Elastic APM.</p>
</div>
<div class="paragraph">
<p>When loaded, the following tracing will occur :-</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each Command execution will exist in a span and have the type <code>Command</code></p>
</li>
<li>
<p>Saga steps will exist in individual transactions/ spans, and will have the type <code>SagaStep</code>. They will join the transaction that
create the source event, if the information exists.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_gathering_metrics"><a class="anchor" href="#_gathering_metrics"></a>Gathering Metrics</h3>
<div class="paragraph">
<p>The highly asynchronous nature of Event systems requires different monitoring.  Eventicle gathers some metrics for you to aid in this.</p>
</div>
<div class="paragraph">
<p>Eventicle will automatically gather runtime metrics for the following :-</p>
</div>
<div class="ulist">
<ul>
<li>
<p>View event latency, latest value.</p>
</li>
<li>
<p>Adapter event latency, latest value.</p>
</li>
<li>
<p>Saga event latency (for each event step), latest value.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are all lazily created, and so the metric will only exist if the view/ adapter/ saga has received an event.</p>
</div>
<div class="paragraph">
<p>They can be obtained like so</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">import {metrics} from "@eventicle/eventiclejs";

let metricDoc = metrics()
console.log(metricDoc)

{
"view-latency":
   {
      "user-view": {
         "latest": 40,           <i class="conum" data-value="1"></i><b>(1)</b>
         "user.created": 40      <i class="conum" data-value="2"></i><b>(2)</b>
      },
      "user-view-v2":{
          "latest": 4403371,      <i class="conum" data-value="3"></i><b>(3)</b>
          "user.created": 4403371,
          "user.delete": 440971,
      },
    },
"saga-latency" : { .. as above },
"adapter-latency" : { .. as above }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A view, with the consumer group "user-view". This view has a low latency and appears to be running well.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The individual event types that the view has received are given their own latency, plus the last event received in the "latest" property.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This view has very high latencies, and is most likely performing a historical replay.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Care needs to be taken during initial View creation, as they will perform a full event replay of their streams, and so
will start to show latency metrics for the event they are currently at.   This will rapidly change as they replay the stream,
but may start far in the past and so will show excessively high apparent latencies.</p>
</div>
<div class="paragraph">
<p>Once the view has come up to near current, latencies will be reasonable and can be used to monitor view consistency health.
This will only be true if events are still being produced as the view is replaying. If the view is only replaying historical data,
then the latency will continue to show the time from the last event createdAt time and the time the view processed the event.</p>
</div>
<div class="paragraph">
<p>Metrics do not persist beyond application restart.</p>
</div>
<div class="paragraph">
<p>Latency metrics should be used to monitor if one of the above components is processing events too slowly and is falling behind.</p>
</div>
<div class="paragraph">
<p>They should not be used to understand if a view/ saga is "up to date". This is conceptually difficult in an eventually consistent, as there
is no globally consistent view of what "up to date" or "current" actually is.</p>
</div>
<div class="paragraph">
<p>If you wish to know if a view is consistent with some action, structure your view such that it can answer if it has
successfully processed the event(s) that were created by the action. This gives you a specific form of consistency check
that is straightforward to implement.</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
