<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Datastore :: Eventicle JS</title>
    <link rel="canonical" href="https://book.eventicle.com/eventiclejs/book/datastore.html">
    <meta name="generator" content="Antora 3.1.0">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script>mermaid.initialize("{ startOnLoad: true }");</script><header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://book.eventicle.com">Eventicle JS</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Components</a>
          <div class="navbar-dropdown">
              <a class="navbar-item" href="../index.html">EventicleJS</a>
              <a class="navbar-item" href="../../eventicle-utilities/docs/index.html">EventicleJS Utilities</a>
              <a class="navbar-item" href="../../datastore-postgres/main/index.html">Postgres Datastore</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="https://github.com/eventicle/eventiclejs">EventicleJS Repository</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="eventiclejs" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">EventicleJS</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../index.html">The Book of Eventicle</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="aggregate-roots.html">Aggregate Roots</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="commands.html">Commands</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="sagas.html">Sagas</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="query.html">Querying Data</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="datastore.html">The Datastore</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="observability.html">Observability</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="testing.html">Testing</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">API documentation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../api/eventicle_eventiclejs.html">@eventicle/eventiclejs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_AggregateRoot_class.html">AggregateRoot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_Command_interface.html">Command</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_CommandIntent_interface.html">CommandIntent</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_CommandReturn_interface.html">CommandReturn</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EncodedEvent_interface.html">EncodedEvent</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventAdapter_interface.html">EventAdapter</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventClientCodec_interface.html">EventClientCodec</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventicleEvent_interface.html">EventicleEvent</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventView_interface.html">EventView</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_InMemoryDatastore_class.html">InMemoryDatastore</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_LocalScheduleJobRunner_class.html">LocalScheduleJobRunner</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_RawEventView_interface.html">RawEventView</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_SagaInstance_class.html">SagaInstance</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">EventicleJS</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">EventicleJS</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../eventicle-utilities/docs/index.html">EventicleJS Utilities</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../eventicle-utilities/docs/index.html">docs</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../datastore-postgres/main/index.html">Postgres Datastore</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../datastore-postgres/main/index.html">main</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">EventicleJS</a></li>
    <li><a href="../index.html">The Book of Eventicle</a></li>
    <li><a href="datastore.html">The Datastore</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/eventicle/eventiclejs/edit/master/docs/modules/book/pages/datastore.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Datastore</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The datastore is a lightweight data persistence interface. It is used by Eventicle to store state for various components.  You can also use it in your Eventicle components to perform CRUD and simple queries.</p>
</div>
<div class="paragraph">
<p>If you need more advanced querying capabilities, you can use whichever data persistence technology is most appropriate in your component.</p>
</div>
<div class="paragraph">
<p>Datastore usage assumes that the underlying implementation can store and query schemaless document style data.  For example, MongoDB or Postgres JSONB.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create"><a class="anchor" href="#_create"></a>Create</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="title">Create a new data Record</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">import { dataStore } from '@eventicle/eventiclejs';
import { Record } from '@eventicle/eventiclejs/dist/datastore';

...

const record: Record = await dataStore().createEntity(
    "system",         <i class="conum" data-value="1"></i><b>(1)</b>
    "my-data-type",   <i class="conum" data-value="2"></i><b>(2)</b>
    {}                <i class="conum" data-value="3"></i><b>(3)</b>
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The tenancy key. If your system is single tenant, ignore this</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The data type. eg <code>saga-instance</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The content of the record. Datastore accepts any JSON data type.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_save"><a class="anchor" href="#_save"></a>Save</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="title">Save an existing data Record</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">import { dataStore } from '@eventicle/eventiclejs';
import { Record } from '@eventicle/eventiclejs/dist/datastore';

...

const record: Record = ... // obtain an existing data record from the

record.content.myData = "hello"  <i class="conum" data-value="1"></i><b>(1)</b>

await dataStore().saveEntity(
    "system",         <i class="conum" data-value="2"></i><b>(2)</b>
    "my-data-type",   <i class="conum" data-value="3"></i><b>(3)</b>
    record            <i class="conum" data-value="4"></i><b>(4)</b>
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Mutate the content as required. Will persist on calling <code>saveEntity</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The tenancy key. If your system is single tenant, ignore this</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The data type. eg <code>saga-instance</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>An existing <code>Record</code> to persist.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_findentity_findentitypaginated"><a class="anchor" href="#_findentity_findentitypaginated"></a>findEntity/ findEntityPaginated</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_transactions"><a class="anchor" href="#_transactions"></a>Transactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The transaction API on the Datastore ensures that any underlying ACID/ transactional commit system is used for datastore operations.</p>
</div>
<div class="listingblock">
<div class="title">Transaction that successfully commits</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">---
const ret: Record = await dataStore().transaction(async () =&gt; {
    // .. do work within the transaction</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>    return datastore().createEntity(...)
})</pre>
</div>
</div>
<div class="paragraph">
<p>console.log(ret.content)</p>
</div>
<hr>
<div class="listingblock">
<div class="title">Transaction that Rolls Back</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">---
const ret: Record = await dataStore().transaction(async () =&gt; {
    // .. do work within the transaction</code></pre>
</div>
</div>
<div class="paragraph">
<p>})</p>
</div>
<div class="paragraph">
<p>console.log(ret.content)</p>
</div>
<hr>
<div class="sect2">
<h3 id="_transactiondata"><a class="anchor" href="#_transactiondata"></a>TransactionData</h3>

</div>
<div class="sect2">
<h3 id="_transactionoptions"><a class="anchor" href="#_transactionoptions"></a>TransactionOptions</h3>

</div>
<div class="sect2">
<h3 id="_transactionlistener"><a class="anchor" href="#_transactionlistener"></a>TransactionListener</h3>
<div class="paragraph">
<p>Components may need to be aware when transactions commit in order to perform work once the datastore is consistent.</p>
</div>
<div class="paragraph">
<p>Notably, <code>eventClient</code> implementations that are transaction aware register a TransactionListener to ensure that they can delay sending events until after the wrapping transaction is successfully committed to the datastore. This ensures that local data changes are fully consistent before events are sent out, preventing a race.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_types"><a class="anchor" href="#_data_types"></a>Data Types</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following data types are persisted using the datastore by Eventicle.</p>
</div>
<div class="paragraph">
<p>You should consider them reserved.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Data Type</th>
<th class="tableblock halign-left valign-top">Datatore <code>type</code></th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aggregate Root State</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aggregate-events-[type]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The raw state of the Aggregate Root, stored as the in order events that have been generated by it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Saga State</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>saga-instance</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The runtime state of a particular Saga instance (created during the <code>startsOn</code> for the Saga)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Saga notification listener</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>saga-notify-intent</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A record that is used to match saga instances against an incoming event. Can match multiple saga instances for a single event</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
