<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: Eventicle JS</title>
    <link rel="canonical" href="https://book.eventicle.com/eventiclejs/doc-update/extension/kafka.html">
    <meta name="generator" content="Antora 3.1.0">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});
    </script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://book.eventicle.com">Eventicle JS</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
<!--    <div id="topbar-nav" class="navbar-menu">-->
<!--      <div class="navbar-end">-->
<!--        <a class="navbar-item" href="#">Home</a>-->
<!--        <div class="navbar-item has-dropdown is-hoverable">-->
<!--          <a class="navbar-link" href="#">Products</a>-->
<!--          <div class="navbar-dropdown">-->
<!--            <a class="navbar-item" href="#">Product A</a>-->
<!--            <a class="navbar-item" href="#">Product B</a>-->
<!--            <a class="navbar-item" href="#">Product C</a>-->
<!--          </div>-->
<!--        </div>-->
<!--        <div class="navbar-item has-dropdown is-hoverable">-->
<!--          <a class="navbar-link" href="#">Services</a>-->
<!--          <div class="navbar-dropdown">-->
<!--            <a class="navbar-item" href="#">Service A</a>-->
<!--            <a class="navbar-item" href="#">Service B</a>-->
<!--            <a class="navbar-item" href="#">Service C</a>-->
<!--          </div>-->
<!--        </div>-->
<!--        <div class="navbar-item">-->
<!--          <span class="control">-->
<!--            <a class="button is-primary" href="#">Download</a>-->
<!--          </span>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="eventiclejs" data-version="doc-update">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">EventicleJS</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">The Book of Eventicle</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../book/index.html">Quick Start</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">The Book of Eventicle</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../book/aggregate-roots.html">Aggregate Roots</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../book/commands.html">Commands</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../book/sagas.html">Sagas</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../book/query.html">Querying Data</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../book/datastore.html">The Datastore</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../book/observability.html">Observability</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../book/testing.html">Testing</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">API documentation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../api/eventicle_eventiclejs.html">@eventicle/eventiclejs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_AggregateRoot_class.html">AggregateRoot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_Command_interface.html">Command</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_CommandIntent_interface.html">CommandIntent</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_CommandReturn_interface.html">CommandReturn</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EncodedEvent_interface.html">EncodedEvent</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventAdapter_interface.html">EventAdapter</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventClientCodec_interface.html">EventClientCodec</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventicleEvent_interface.html">EventicleEvent</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_EventView_interface.html">EventView</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_InMemoryDatastore_class.html">InMemoryDatastore</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_LocalScheduleJobRunner_class.html">LocalScheduleJobRunner</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_RawEventView_interface.html">RawEventView</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/eventicle_eventiclejs_SagaInstance_class.html">SagaInstance</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">EventicleJS</span>
    <span class="version">doc-update</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">EventicleJS</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">doc-update</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="https://github.com/eventicle/eventiclejs/edit/doc-update/docs/modules/extension/pages/kafka.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<div class="sect1">
<h2 id="_kafka"><a class="anchor" href="#_kafka"></a>Kafka</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Eventicle has an <code>EventClient</code> implementation built using <a href="https://kafka.js.org/">KafkaJS</a>.</p>
</div>
<div class="sect2">
<h3 id="_setup"><a class="anchor" href="#_setup"></a>Setup</h3>
<div class="listingblock">
<div class="title">Create Kafka EventClient</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">import {setEventClient, eventClientOnKafka} from "@eventicle/eventiclejs";
import {KafkaConfig} from "kafkajs";

const kafkaConfig = {
    clientId: 'your-service',
    brokers: "localhost:9092",
    ssl: true
  } as KafkaConfig

setEventClient(await eventClientOnKafka(kafkaConfig));</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want lower level control of how KafkaJS will set up the consumer connection, you can pass a <code>ConsumerConfigFactory</code>
object that will be used by the Kafka Event Client to configure the consumers as they are created, by views, adapters or other higher level components.</p>
</div>
<div class="listingblock">
<div class="title">Create Kafka EventClient with custom ConsumerConfigFactory</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">import {setEventClient, eventClientOnKafka} from "@eventicle/eventiclejs";
import {KafkaConfig} from "kafkajs";
import {ConsumerConfigStreamType} from "@eventicle/eventiclejs/dist/events/core/eventclient-kafka";

const kafkaConfig = {
    clientId: 'your-service',
    brokers: "localhost:9092",
    ssl: true
  } as KafkaConfig

setEventClient(await eventClientOnKafka(kafkaConfig, {
    consumerConfig: (stream: any, consumerName: string, type: ConsumerConfigStreamType) =&gt; {
      return {
        maxWaitTimeInMs: 100,
        groupId: consumerName
      }
    },
    consumerRunConfig: (stream: any, consumerName: string, type: ConsumerConfigStreamType) =&gt; {
      if (type === "COLD") {
        return {
          autoCommit: true,
          autoCommitInterval: 500,
          autoCommitThreshold: 50
        }
      }
      return {
        autoCommit: true,
        autoCommitInterval: 500,
        autoCommitThreshold: 50,
        partitionsConsumedConcurrently: 50,
      }
    }
  }
));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_connection_health"><a class="anchor" href="#_connection_health"></a>Connection Health</h3>
<div class="paragraph">
<p>You can observe the health of the kafka client via the <code>getKafkaClientHealth()</code> function.</p>
</div>
<div class="paragraph">
<p>This health state is maintained from the events coming from the KafkaJS components, and does not cause any runtime traffic when called.</p>
</div>
<div class="paragraph">
<p>Due to the way Kafka clients operate, it will show an indication of health, but may lag a few seconds after a failure occurs before the failure showing in the healthcheck.</p>
</div>
<div class="paragraph">
<p>Specific connection statuses can be found in the <code>producer</code> and <code>consumer[]</code> properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-typescript hljs" data-lang="typescript">import {getKafkaClientHealth, KafkaClientHealth} from "@eventicle/eventiclejs/dist/events/core/eventclient-kafka";

const health: KafkaClientHealth = getKafkaClientHealth()

console.log("Is healthy: " + health.healthy)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the eventClient shutdown has been called, the producer and all consumers will
have the HealthCheckStatus - <code>"disconnected"</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_integration_with_datastore_transactions"><a class="anchor" href="#_integration_with_datastore_transactions"></a>Integration With Datastore Transactions</h3>
<div class="paragraph">
<p>The Kafka Event Client is transaction aware.  If a datastore transaction is underway, then calls to <code>eventClient().emit( &#8230;&#8203; )</code> will cause the
given event to be buffered in the transaction context until the transaction commits.</p>
</div>
<div class="paragraph">
<p>When the transaction manager emits a <code>transaction.commit</code> then pending events will be sent to Kafka as normal.  Promises returned by `eventClient().emit() are resolved when the events are sent to Kafka, whether the event is stored in the transactional context or not.</p>
</div>
<div class="paragraph">
<p>This ensures that AggregateRoot operations fully complete and are flushed to the datastore before the events that it produces becoming visible to the rest of the system.</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
